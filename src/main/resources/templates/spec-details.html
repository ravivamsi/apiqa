<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>APIQA - API Specification Details</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    
    <style>
        .sidebar {
            min-height: 100vh;
            background-color: #f8f9fa;
        }
        .main-content {
            padding: 20px;
        }
        .card-hover:hover {
            transform: translateY(-2px);
            transition: transform 0.2s;
        }
        .status-badge {
            font-size: 0.8em;
        }
        
        /* Gherkin Syntax Highlighting */
        .gherkin-content {
            font-family: 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.6;
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            white-space: pre-wrap;
            word-wrap: break-word;
            max-height: 70vh;
            overflow-y: auto;
        }
        
        .gherkin-keyword {
            color: #2c3e50;
            font-weight: bold;
            background-color: rgba(44, 62, 80, 0.1);
            padding: 2px 4px;
            border-radius: 3px;
        }
        
        .gherkin-value {
            color: #27ae60;
            font-weight: bold;
            background-color: rgba(39, 174, 96, 0.1);
            padding: 2px 4px;
            border-radius: 3px;
        }
        
        .gherkin-description {
            color: #212529;
        }
        
        .gherkin-comment {
            color: #6c757d;
            font-style: italic;
        }
        
        .gherkin-table {
            margin: 10px 0;
            border-collapse: collapse;
            width: 100%;
        }
        
        .gherkin-table th,
        .gherkin-table td {
            border: 1px solid #dee2e6;
            padding: 8px;
            text-align: left;
        }
        
        .gherkin-table th {
            background-color: #e9ecef;
            font-weight: bold;
        }
        
        .gherkin-table td {
            background-color: #ffffff;
        }
        
        .gherkin-examples {
            margin: 15px 0;
            padding: 10px;
            background-color: #f8f9fa;
            border-left: 4px solid #2c3e50;
        }
        
        .gherkin-scenario {
            margin: 10px 0;
            padding: 8px;
            background-color: #f8f9fa;
            border-left: 4px solid #2c3e50;
        }
        
        .gherkin-feature {
            margin: 10px 0;
            padding: 8px;
            background-color: #f8f9fa;
            border-left: 4px solid #2c3e50;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <nav class="col-md-3 col-lg-2 d-md-block sidebar collapse">
                <div class="position-sticky pt-3">
                    <div class="text-center mb-4">
                        <h4 class="text-primary">APIQA</h4>
                        <small class="text-muted">API Quality Analysis</small>
                    </div>
                    
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link" th:href="@{/}">
                                <i class="bi bi-house-door"></i> Dashboard
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" th:href="@{/specs}">
                                <i class="bi bi-file-earmark-code"></i> API Specs
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" th:href="@{/test-runs}">
                                <i class="bi bi-play-circle"></i> Test Runs
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" th:href="@{/admin}">
                                <i class="bi bi-gear"></i> Admin Panel
                            </a>
                        </li>
                    </ul>
                </div>
            </nav>
            
            <!-- Main content -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4 main-content">
                <!-- Alerts -->
                <div th:if="${param.success}" class="alert alert-success alert-dismissible fade show" role="alert">
                    <i class="bi bi-check-circle"></i> <span th:text="${param.success[0]}"></span>
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
                
                <div th:if="${param.error}" class="alert alert-danger alert-dismissible fade show" role="alert">
                    <i class="bi bi-exclamation-triangle"></i> <span th:text="${param.error[0]}"></span>
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
                
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2" th:text="${apiSpec.name}">API Specification</h1>
                    <div class="btn-toolbar mb-2 mb-md-0">
                        <button type="button" class="btn btn-success me-2" th:onclick="'generateTests(' + ${apiSpec.id} + ')'">
                            <i class="bi bi-gear"></i> Generate Tests
                        </button>
                        <button type="button" class="btn btn-primary" th:onclick="'runTests(' + ${apiSpec.id} + ')'">
                            <i class="bi bi-play-circle"></i> Run Tests
                        </button>
                    </div>
                </div>
                
                <!-- API Spec Info -->
                <div class="row mb-4">
                    <div class="col-md-8">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="card-title mb-0">Specification Details</h5>
                            </div>
                            <div class="card-body">
                                <dl class="row">
                                    <dt class="col-sm-3">Name:</dt>
                                    <dd class="col-sm-9" th:text="${apiSpec.name}">Spec Name</dd>
                                    
                                    <dt class="col-sm-3">Version:</dt>
                                    <dd class="col-sm-9">
                                        <span class="badge bg-secondary" th:text="${apiSpec.version}">v1.0.0</span>
                                    </dd>
                                    
                                    <dt class="col-sm-3">Uploaded At:</dt>
                                    <dd class="col-sm-9" th:text="${apiSpec.uploadedAt}">2023-01-01 12:00:00</dd>
                                </dl>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="card-title mb-0">Quick Actions</h5>
                            </div>
                            <div class="card-body">
                                <div class="d-grid gap-2">
                                    <button type="button" class="btn btn-success" th:onclick="'generateTests(' + ${apiSpec.id} + ')'">
                                        <i class="bi bi-gear"></i> Generate Tests
                                    </button>
                                    <button type="button" class="btn btn-primary" th:onclick="'runTests(' + ${apiSpec.id} + ')'">
                                        <i class="bi bi-play-circle"></i> Run Tests
                                    </button>
                                    <button type="button" class="btn btn-info" data-bs-toggle="modal" data-bs-target="#yamlModal">
                                        <i class="bi bi-code-square"></i> View YAML
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Feature Files -->
                <div class="row mb-4" th:if="${apiSpec.featureFiles != null and !apiSpec.featureFiles.isEmpty()}">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="card-title mb-0">Generated Feature Files</h5>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead>
                                            <tr>
                                                <th>File Name</th>
                                                <th>Suite Type</th>
                                                <th>Generated At</th>
                                                <th>Scenarios</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr th:each="feature : ${apiSpec.featureFiles}">
                                                <td th:text="${feature.fileName}">feature.feature</td>
                                                <td>
                                                    <span th:class="'badge ' + (${feature.suiteType.name()} == 'SMOKE' ? 'bg-success' : (${feature.suiteType.name()} == 'SYSTEM' ? 'bg-warning' : 'bg-info'))"
                                                          th:text="${feature.suiteType.name()}">SMOKE</span>
                                                </td>
                                                <td th:text="${feature.generatedAt}">2023-01-01 12:00</td>
                                                <td th:text="${feature.testScenarios != null ? feature.testScenarios.size() : 0}">0</td>
                                                <td>
                                                    <button type="button" class="btn btn-sm btn-outline-primary" 
                                                            th:data-file-name="${feature.fileName}"
                                                            th:data-feature-id="${feature.id}"
                                                            onclick="viewFeature(this.dataset.fileName, this.dataset.featureId)">
                                                        <i class="bi bi-eye"></i> View
                                                    </button>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Test Runs -->
                <div class="row">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="card-title mb-0">Test Runs</h5>
                            </div>
                            <div class="card-body">
                                <div th:if="${testRuns != null and !testRuns.isEmpty()}">
                                    <div class="table-responsive">
                                        <table class="table table-hover">
                                            <thead>
                                                <tr>
                                                    <th>Run Name</th>
                                                    <th>Type</th>
                                                    <th>Status</th>
                                                    <th>Started At</th>
                                                    <th>Duration</th>
                                                    <th>Results</th>
                                                    <th>Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr th:each="run : ${testRuns}">
                                                    <td th:text="${run.runName}">Test Run</td>
                                                    <td>
                                                        <span class="badge bg-secondary" th:text="${run.runType.name()}">MANUAL</span>
                                                    </td>
                                                    <td>
                                                        <span th:class="'badge ' + (${run.status.name()} == 'COMPLETED' ? 'bg-success' : (${run.status.name()} == 'FAILED' ? 'bg-danger' : (${run.status.name()} == 'RUNNING' ? 'bg-warning' : 'bg-secondary')))"
                                                              th:text="${run.status.name()}">PENDING</span>
                                                    </td>
                                                    <td th:text="${run.startedAt != null ? run.startedAt : 'N/A'}">2023-01-01 12:00</td>
                                                    <td th:text="${run.completedAt != null and run.startedAt != null ? 
                                                                  run.completedAt + ' - ' + run.startedAt : 'N/A'}">N/A</td>
                                                    <td>
                                                        <span th:if="${run.totalTests != null}" class="badge bg-info" 
                                                              th:text="${run.passedTests} + '/' + ${run.totalTests}">0/0</span>
                                                    </td>
                                                    <td>
                                                        <a th:href="@{/test-runs/{id}(id=${run.id})}" class="btn btn-sm btn-outline-primary">
                                                            <i class="bi bi-eye"></i> View
                                                        </a>
                                                        <button th:if="${run.status.name() == 'FAILED'}" type="button" class="btn btn-sm btn-outline-warning ms-1" 
                                                                th:onclick="'retryTests(' + ${run.id} + ')'">
                                                            <i class="bi bi-arrow-clockwise"></i> Retry
                                                        </button>
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                                <div th:if="${testRuns == null or testRuns.isEmpty()}" class="text-center text-muted py-3">
                                    <i class="bi bi-play-circle fs-1"></i>
                                    <p>No test runs yet. Generate and run tests to see results here.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- YAML Modal -->
                <div class="modal fade" id="yamlModal" tabindex="-1">
                    <div class="modal-dialog modal-xl">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">OpenAPI YAML</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <pre><code th:text="${apiSpec.openApiYaml}">YAML content here</code></pre>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Feature Content Modal -->
                <div class="modal fade" id="featureModal" tabindex="-1">
                    <div class="modal-dialog modal-xl">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="featureModalTitle">
                                    <i class="bi bi-file-earmark-code"></i> Feature File
                                </h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="gherkin-content" id="featureModalContent">
                                    <div class="text-center text-muted">
                                        <i class="bi bi-hourglass-split"></i>
                                        Loading feature content...
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                    <i class="bi bi-x-circle"></i> Close
                                </button>
                                <button type="button" class="btn btn-outline-primary" onclick="copyFeatureContent()">
                                    <i class="bi bi-clipboard"></i> Copy Content
                                </button>
                                <button type="button" class="btn btn-success" onclick="downloadFeatureFile()">
                                    <i class="bi bi-download"></i> Download
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Run Tests Modal -->
                <div class="modal fade" id="runTestsModal" tabindex="-1">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Run Tests</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <form th:action="@{/specs/{id}/run-tests(id=${apiSpec.id})}" method="post">
                                <div class="modal-body">
                                    <div class="mb-3">
                                        <label for="runName" class="form-label">Run Name</label>
                                        <input type="text" class="form-control" id="runName" name="runName" 
                                               th:value="'Test Run - ' + ${#dates.format(#dates.createNow(), 'yyyy-MM-dd HH:mm')}" required>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                    <button type="submit" class="btn btn-primary">Start Test Run</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                
                <!-- Run Tests by Suite Modal -->
                <div class="modal fade" id="runTestsBySuiteModal" tabindex="-1">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Run Tests by Suite Type</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <form th:action="@{/specs/{id}/run-tests-by-suite(id=${apiSpec.id})}" method="post">
                                <div class="modal-body">
                                    <div class="mb-3">
                                        <label for="suiteRunName" class="form-label">Run Name</label>
                                        <input type="text" class="form-control" id="suiteRunName" name="runName" 
                                               th:value="'Test Run - ' + ${#dates.format(#dates.createNow(), 'yyyy-MM-dd HH:mm')}" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="suiteType" class="form-label">Select Suite Type</label>
                                        <select class="form-select" id="suiteType" name="suiteType" required>
                                            <option value="">Choose a suite type...</option>
                                            <option th:each="feature : ${apiSpec.featureFiles}" 
                                                    th:value="${feature.suiteType.name()}" 
                                                    th:text="${feature.suiteType.name()} + ' - ' + ${feature.fileName}">
                                                SMOKE - smoke_tests.feature
                                            </option>
                                        </select>
                                        <div class="form-text">
                                            <strong>SMOKE:</strong> Quick validation of basic API functionality<br>
                                            <strong>SYSTEM:</strong> Comprehensive testing of all CRUD operations<br>
                                            <strong>INTEGRATION:</strong> End-to-end workflow and integration tests
                                        </div>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                    <button type="submit" class="btn btn-primary">Start Suite Test Run</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>
    
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        function generateTests(specId) {
            if (confirm('Generate test cases for this API specification?')) {
                fetch('/specs/' + specId + '/generate-tests', {
                    method: 'POST'
                }).then(response => {
                    if (response.ok) {
                        location.reload();
                    } else {
                        alert('Failed to generate tests');
                    }
                });
            }
        }
        
        function runTests(specId) {
            new bootstrap.Modal(document.getElementById('runTestsBySuiteModal')).show();
        }
        
        function retryTests(runId) {
            if (confirm('Retry failed tests for this run?')) {
                fetch('/test-runs/' + runId + '/retry', {
                    method: 'POST'
                }).then(response => {
                    if (response.ok) {
                        location.reload();
                    } else {
                        alert('Failed to retry tests');
                    }
                });
            }
        }
        
        // Store original content for download
        let currentFeatureContent = '';
        let currentFeatureFileName = '';
        
        function viewFeature(fileName, featureId) {
            currentFeatureFileName = fileName;
            document.getElementById('featureModalTitle').innerHTML = '<i class="bi bi-file-earmark-code"></i> ' + fileName;
            
            // Show loading message
            const contentElement = document.getElementById('featureModalContent');
            contentElement.innerHTML = '<div class="text-center text-muted"><i class="bi bi-hourglass-split"></i> Loading feature content...</div>';
            
            // Show modal first
            new bootstrap.Modal(document.getElementById('featureModal')).show();
            
            // Fetch content via AJAX
            fetch('/api/feature-content/' + featureId)
                .then(response => response.text())
                .then(content => {
                    currentFeatureContent = content;
                    console.log('Raw content length:', content.length);
                    console.log('Raw content sample:', content.substring(0, 300));
                    
                    // Display as plain text without HTML highlighting
                    let cleanContent = content;
                    
                    // Remove all HTML tags completely
                    cleanContent = cleanContent.replace(/<[^>]*>/g, '');
                    
                    // Also handle HTML entities
                    cleanContent = cleanContent.replace(/&lt;/g, '<').replace(/&gt;/g, '>').replace(/&amp;/g, '&');
                    
                    console.log('Clean content:', cleanContent.substring(0, 200));
                    
                    // Display as plain text in a pre-formatted block
                    contentElement.innerHTML = '<pre class="gherkin-content" style="white-space: pre-wrap; font-family: monospace; background-color: #f8f9fa; padding: 1rem; border-radius: 0.375rem; border: 1px solid #dee2e6;">' + escapeHtml(cleanContent) + '</pre>';
                })
                .catch(error => {
                    console.error('Error fetching feature content:', error);
                    contentElement.innerHTML = '<div class="text-danger">Error loading feature content</div>';
                });
        }
        
        function stripHtmlTags(html) {
            // Create a temporary div to parse HTML and extract text content
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = html;
            return tempDiv.textContent || tempDiv.innerText || '';
        }
        
        function highlightGherkin(content) {
            if (!content) return '<div class="text-muted">No content available</div>';
            
            // Check if content already contains HTML tags (already highlighted)
            if (content.includes('<span class="gherkin-')) {
                // Content is already highlighted, strip HTML and re-highlight properly
                return stripHtmlAndHighlight(content);
            }
            
            // Split content into lines
            const lines = content.split('\n');
            let highlightedContent = '';
            let inTable = false;
            let inCodeBlock = false;
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];
                const trimmedLine = line.trim();
                
                // Skip empty lines
                if (trimmedLine === '') {
                    highlightedContent += '<br>';
                    continue;
                }
                
                // Handle comments
                if (trimmedLine.startsWith('#')) {
                    highlightedContent += '<div class="gherkin-comment">' + escapeHtml(line) + '</div>';
                    continue;
                }
                
                // Handle Feature
                if (trimmedLine.startsWith('Feature:')) {
                    highlightedContent += '<div class="gherkin-feature">';
                    highlightedContent += highlightLine(line);
                    highlightedContent += '</div>';
                    continue;
                }
                
                // Handle Scenario/Scenario Outline
                if (trimmedLine.startsWith('Scenario') || trimmedLine.startsWith('Background:')) {
                    highlightedContent += '<div class="gherkin-scenario">';
                    highlightedContent += highlightLine(line);
                    highlightedContent += '</div>';
                    continue;
                }
                
                // Handle Examples
                if (trimmedLine.startsWith('Examples:') || trimmedLine.startsWith('Example:')) {
                    highlightedContent += '<div class="gherkin-examples">';
                    highlightedContent += highlightLine(line);
                    highlightedContent += '</div>';
                    continue;
                }
                
                // Handle table rows
                if (trimmedLine.startsWith('|') && trimmedLine.endsWith('|')) {
                    if (!inTable) {
                        highlightedContent += '<table class="gherkin-table">';
                        inTable = true;
                    }
                    highlightedContent += '<tr>';
                    const cells = trimmedLine.split('|').slice(1, -1);
                    cells.forEach(cell => {
                        const cellContent = cell.trim();
                        if (cellContent) {
                            highlightedContent += '<td>' + highlightLine(cellContent) + '</td>';
                        } else {
                            highlightedContent += '<td></td>';
                        }
                    });
                    highlightedContent += '</tr>';
                    continue;
                } else if (inTable) {
                    highlightedContent += '</table>';
                    inTable = false;
                }
                
                // Handle code blocks
                if (trimmedLine.startsWith('"""') || trimmedLine.startsWith('```')) {
                    if (!inCodeBlock) {
                        highlightedContent += '<pre class="bg-light p-2 rounded"><code>';
                        inCodeBlock = true;
                    } else {
                        highlightedContent += '</code></pre>';
                        inCodeBlock = false;
                    }
                    continue;
                }
                
                // Regular lines
                if (inCodeBlock) {
                    highlightedContent += escapeHtml(line) + '<br>';
                } else {
                    highlightedContent += '<div class="gherkin-description">' + highlightLine(line) + '</div>';
                }
            }
            
            // Close any open table
            if (inTable) {
                highlightedContent += '</table>';
            }
            
            return highlightedContent;
        }
        
        function cleanAndHighlightContent(content) {
            // First, strip all HTML tags to get clean text
            const cleanContent = content.replace(/<[^>]*>/g, '');
            
            // Now apply proper highlighting to the clean content (avoid recursion)
            return highlightGherkinContent(cleanContent);
        }
        
        function stripHtmlAndHighlight(content) {
            // Create a temporary div to parse HTML and extract text content
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = content;
            const cleanText = tempDiv.textContent || tempDiv.innerText || '';
            
            // Now apply proper highlighting to the clean text
            return highlightGherkinContent(cleanText);
        }
        
        function highlightGherkinContent(content) {
            if (!content) return '<div class="text-muted">No content available</div>';
            
            console.log('Highlighting content:', content.substring(0, 100) + '...');
            
            // Split content into lines
            const lines = content.split('\n');
            let highlightedContent = '';
            let inTable = false;
            let inCodeBlock = false;
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];
                const trimmedLine = line.trim();
                
                // Skip empty lines
                if (trimmedLine === '') {
                    highlightedContent += '<br>';
                    continue;
                }
                
                // Handle comments
                if (trimmedLine.startsWith('#')) {
                    highlightedContent += '<div class="gherkin-comment">' + escapeHtml(line) + '</div>';
                    continue;
                }
                
                // Handle Feature
                if (trimmedLine.startsWith('Feature:')) {
                    highlightedContent += '<div class="gherkin-feature">';
                    highlightedContent += highlightLine(line);
                    highlightedContent += '</div>';
                    continue;
                }
                
                // Handle Scenario/Scenario Outline
                if (trimmedLine.startsWith('Scenario') || trimmedLine.startsWith('Background:')) {
                    highlightedContent += '<div class="gherkin-scenario">';
                    highlightedContent += highlightLine(line);
                    highlightedContent += '</div>';
                    continue;
                }
                
                // Handle Examples
                if (trimmedLine.startsWith('Examples:') || trimmedLine.startsWith('Example:')) {
                    highlightedContent += '<div class="gherkin-examples">';
                    highlightedContent += highlightLine(line);
                    highlightedContent += '</div>';
                    continue;
                }
                
                // Handle table rows
                if (trimmedLine.startsWith('|') && trimmedLine.endsWith('|')) {
                    if (!inTable) {
                        highlightedContent += '<table class="gherkin-table">';
                        inTable = true;
                    }
                    highlightedContent += '<tr>';
                    const cells = trimmedLine.split('|').slice(1, -1);
                    cells.forEach(cell => {
                        const cellContent = cell.trim();
                        if (cellContent) {
                            highlightedContent += '<td>' + highlightLine(cellContent) + '</td>';
                        } else {
                            highlightedContent += '<td></td>';
                        }
                    });
                    highlightedContent += '</tr>';
                    continue;
                } else if (inTable) {
                    highlightedContent += '</table>';
                    inTable = false;
                }
                
                // Handle code blocks
                if (trimmedLine.startsWith('"""') || trimmedLine.startsWith('```')) {
                    if (!inCodeBlock) {
                        highlightedContent += '<pre class="bg-light p-2 rounded"><code>';
                        inCodeBlock = true;
                    } else {
                        highlightedContent += '</code></pre>';
                        inCodeBlock = false;
                    }
                    continue;
                }
                
                // Regular lines
                if (inCodeBlock) {
                    highlightedContent += escapeHtml(line) + '<br>';
                } else {
                    highlightedContent += '<div class="gherkin-description">' + highlightLine(line) + '</div>';
                }
            }
            
            // Close any open table
            if (inTable) {
                highlightedContent += '</table>';
            }
            
            console.log('Highlighted content:', highlightedContent.substring(0, 200) + '...');
            return highlightedContent;
        }
        
        function formatHighlightedContent(content) {
            // Split content into lines
            const lines = content.split('\n');
            let formattedContent = '';
            let inTable = false;
            let inCodeBlock = false;
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];
                const trimmedLine = line.trim();
                
                // Skip empty lines
                if (trimmedLine === '') {
                    formattedContent += '<br>';
                    continue;
                }
                
                // Check if line starts with Feature:
                if (trimmedLine.includes('Feature:')) {
                    formattedContent += '<div class="gherkin-feature">' + line + '</div>';
                    continue;
                }
                
                // Check if line starts with Scenario or Background:
                if (trimmedLine.includes('Scenario') || trimmedLine.includes('Background:')) {
                    formattedContent += '<div class="gherkin-scenario">' + line + '</div>';
                    continue;
                }
                
                // Check if line starts with Examples:
                if (trimmedLine.includes('Examples:') || trimmedLine.includes('Example:')) {
                    formattedContent += '<div class="gherkin-examples">' + line + '</div>';
                    continue;
                }
                
                // Handle table rows
                if (trimmedLine.startsWith('|') && trimmedLine.endsWith('|')) {
                    if (!inTable) {
                        formattedContent += '<table class="gherkin-table">';
                        inTable = true;
                    }
                    formattedContent += '<tr><td>' + line.replace(/\|/g, '</td><td>') + '</td></tr>';
                    continue;
                } else if (inTable) {
                    formattedContent += '</table>';
                    inTable = false;
                }
                
                // Regular lines
                formattedContent += '<div class="gherkin-description">' + line + '</div>';
            }
            
            // Close any open table
            if (inTable) {
                formattedContent += '</table>';
            }
            
            return formattedContent;
        }
        
        function highlightLine(line) {
            // Don't escape HTML first - we'll handle it differently
            let highlightedLine = line;
            
            // Highlight Gherkin keywords
            const gherkinKeywords = [
                'Feature:', 'Background:', 'Scenario:', 'Scenario Outline:', 
                'Examples:', 'Example:', 'Given', 'When', 'Then', 'And', 'But'
            ];
            
            // Process each keyword
            gherkinKeywords.forEach(keyword => {
                // Create regex pattern for the keyword
                let pattern;
                if (keyword.endsWith(':')) {
                    // For keywords ending with colon (Feature:, Scenario:, etc.)
                    pattern = new RegExp('\\b(' + keyword.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + ')', 'gi');
                } else {
                    // For step keywords (Given, When, Then, etc.)
                    pattern = new RegExp('(^|\\s+)(' + keyword + ')(?=\\s|$)', 'gi');
                }
                
                // Replace with highlighted version
                if (keyword.endsWith(':')) {
                    highlightedLine = highlightedLine.replace(pattern, '<span class="gherkin-keyword">$1</span>');
                } else {
                    highlightedLine = highlightedLine.replace(pattern, '$1<span class="gherkin-keyword">$2</span>');
                }
            });
            
            // Highlight quoted strings
            highlightedLine = highlightedLine.replace(/"([^"]*)"/g, '<span class="gherkin-value">"$1"</span>');
            highlightedLine = highlightedLine.replace(/'([^']*)'/g, '<span class="gherkin-value">\'$1\'</span>');
            
            // Highlight numbers
            highlightedLine = highlightedLine.replace(/\b(\d+)\b/g, '<span class="gherkin-value">$1</span>');
            
            // Highlight table separators
            highlightedLine = highlightedLine.replace(/\|/g, '<span class="gherkin-keyword">|</span>');
            
            // Now escape any remaining HTML that's not our spans
            highlightedLine = escapeHtmlExceptSpans(highlightedLine);
            
            return highlightedLine;
        }
        
        function escapeHtmlExceptSpans(text) {
            // Split by our span tags to preserve them
            const parts = text.split(/(<span class="gherkin-[^"]*">[^<]*<\/span>)/g);
            
            return parts.map(part => {
                // If it's already a span tag, keep it as is
                if (part.match(/^<span class="gherkin-[^"]*">[^<]*<\/span>$/)) {
                    return part;
                }
                // Otherwise escape HTML
                return escapeHtml(part);
            }).join('');
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function copyFeatureContent() {
            // Get the clean content (without HTML tags) for copying
            let cleanContent = currentFeatureContent || '';
            
            // Remove all HTML tags completely
            cleanContent = cleanContent.replace(/<[^>]*>/g, '');
            
            // Also handle HTML entities
            cleanContent = cleanContent.replace(/&lt;/g, '<').replace(/&gt;/g, '>').replace(/&amp;/g, '&');
            
            console.log('Copying clean content:', cleanContent.substring(0, 100));
            
            navigator.clipboard.writeText(cleanContent).then(() => {
                // Show success feedback
                const button = event.target;
                const originalText = button.innerHTML;
                button.innerHTML = '<i class="bi bi-check-circle"></i> Copied!';
                button.classList.remove('btn-outline-primary');
                button.classList.add('btn-success');
                
                setTimeout(() => {
                    button.innerHTML = originalText;
                    button.classList.remove('btn-success');
                    button.classList.add('btn-outline-primary');
                }, 2000);
            }).catch(err => {
                console.error('Failed to copy content: ', err);
                alert('Failed to copy content to clipboard');
            });
        }
        
        function downloadFeatureFile() {
            if (!currentFeatureContent) {
                alert('No feature content available to download');
                return;
            }
            
            // Clean the content for download (remove HTML tags)
            let cleanContent = currentFeatureContent || '';
            
            // Remove all HTML tags completely
            cleanContent = cleanContent.replace(/<[^>]*>/g, '');
            
            // Also handle HTML entities
            cleanContent = cleanContent.replace(/&lt;/g, '<').replace(/&gt;/g, '>').replace(/&amp;/g, '&');
            
            // Prepare filename
            let fileName = currentFeatureFileName || 'feature';
            
            // Remove any existing extension and add .feature
            if (fileName.includes('.')) {
                fileName = fileName.substring(0, fileName.lastIndexOf('.')) + '.feature';
            } else {
                fileName = fileName + '.feature';
            }
            
            // Clean filename (remove invalid characters)
            fileName = fileName.replace(/[^a-zA-Z0-9._-]/g, '_');
            
            // Create blob with the clean feature content
            const blob = new Blob([cleanContent], { type: 'text/plain;charset=utf-8' });
            
            // Create download link
            const url = window.URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = fileName;
            
            // Trigger download
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            // Clean up
            window.URL.revokeObjectURL(url);
            
            // Show success feedback
            const button = event.target;
            const originalText = button.innerHTML;
            button.innerHTML = '<i class="bi bi-check-circle"></i> Downloaded!';
            button.classList.remove('btn-success');
            button.classList.add('btn-outline-success');
            
            setTimeout(() => {
                button.innerHTML = originalText;
                button.classList.remove('btn-outline-success');
                button.classList.add('btn-success');
            }, 2000);
        }
        
        // Debug function to test content processing
        function debugContent(content) {
            console.log('=== DEBUG CONTENT ===');
            console.log('Original length:', content.length);
            console.log('Contains <span:', content.includes('<span'));
            console.log('Contains &lt;span:', content.includes('&lt;span'));
            console.log('First 500 chars:', content.substring(0, 500));
            
            // Test HTML entity decoding
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = content;
            const decoded = tempDiv.textContent || tempDiv.innerText || content;
            console.log('After HTML decode:', decoded.substring(0, 500));
            
            // Test HTML tag removal
            const cleaned = decoded.replace(/<[^>]*>/g, '');
            console.log('After tag removal:', cleaned.substring(0, 500));
            console.log('=== END DEBUG ===');
        }
    </script>
</body>
</html>